ğŸš€ Loki for Logging â€” Centralized Kubernetes Logging from Scratch

ğŸ“˜ Conceptual Explanation (Roman Urdu)
ğŸ” Loki kya hai?
Loki ek log aggregation system hai jo specially Kubernetes ke liye design kiya gaya hai. Ye logs ko efficiently collect, store aur query karta hai â€” Prometheus ki tarah, lekin metrics ke bajaye logs ke liye.

---

â“ Why We Use Loki (Kyu Zarurat Hai Loki ki?)

1. Centralized Logs:
   Kubernetes mein jab multiple pods, containers aur nodes hoti hain, to kubectl logs se har pod ke logs dekhna mushkil hota hai. Loki isko centralize kar deta hai.
2. Real-time Logs without SSH:
   Aapko kisi server mein SSH karne ki zarurat nahi â€” Grafana dashboard se hi sab kuch real-time dekh sakte ho.
3. Query + Filter Support:
   Loki mein aap simple queries se filter kar sakte ho:
   o Kisi pod ka log
   o Specific container ka log
   o Ya logs jismein level=error ho
4. No Extra Agent Overhead:
   Loki lightweight hai, aur Promtail uske sath perfectly integrate hota hai. Koi heavy log collector (jaise ELK) ki zarurat nahi.

---

ğŸ¯ Need of Loki in Kubernetes (Zarurat kyu padti hai Loki ki?)
â€¢ Jab cluster grow karta hai, to logs trace karna impossible ho jata hai.
â€¢ Pods ephemeral hote hain â€” crash hone ke baad logs chalay jaate hain.
â€¢ Agar aap production app chala rahe ho, aur bug aya to logs chahiye hote hain turant.
â€¢ Loki aapko historical + live logs dono access karne deta hai.

---

ğŸ§µ Real-Life Analogy (Roman Urdu Example)
Socho ek factory hai jahan 100 machines kaam kar rahi hain. Agar kisi machine mein fault aaye, to manager ko pata karna hai kis waqt aur kis part mein problem hui.
Agar har machine alag jagah par CCTV camera laga ho, aur manager ko har machine ke paas jaake recording dekhni pade â€” to ye time-consuming aur inefficient hai.
Ab socho ek central CCTV room bana diya jaye, jahan sab machines ka live feed aa raha ho. Sirf ek screen se manager har fault dekh sakta hai.
Bas waise hi Loki kaam karta hai â€” har pod (machine) ka log ek jagah bhejta hai jise tu Grafana se dekh sakta hai. â›“ï¸ğŸ“º

---

Lab work
ğŸ§° What We Will Do:

1. Launch EC2 Ubuntu Server
2. Install Docker + Kubernetes
3. Install Helm
4. Deploy Loki Stack (Loki + Promtail + Grafana)
5. View Logs in Grafana
6. Bonus: Search Pod Logs in Grafana
7. Assignment: View, filter, and save logs from running pods

---

ğŸŸ¢ Step 1: Launch New EC2 Server
â€¢ OS: Ubuntu 22.04 LTS
â€¢ Instance Type: t2.medium (min 2 vCPU, 4 GB RAM)
â€¢ âœ… Open Ports in Security Group:
o 22 (SSH)
o 3000 (Grafana UI)
o 3100 (Loki UI â€“ optional, mostly via Grafana)

---

ğŸŸ¢ Step 2: Install Docker + Kubeadm + Kubectl
(Use same steps from Topic 43)
sudo apt update && sudo apt upgrade -y
sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release software-properties-common
sudo apt install -y docker.io containerd
sudo systemctl enable docker
sudo systemctl start docker

sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
sudo systemctl restart containerd
sudo systemctl enable containerd

sudo swapoff -a
sudo sed -i '/ swap / s/^/#/' /etc/fstab
sudo modprobe overlay
sudo modprobe br_netfilter

cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF

sudo sysctl --system

# Install K8s

sudo mkdir -p /etc/apt/keyrings
curl -fsSL [https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key](https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key) | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] [https://pkgs.k8s.io/core:/stable:/v1.30/deb/](https://pkgs.k8s.io/core:/stable:/v1.30/deb/) /" | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

---

ğŸŸ¢ Step 3: Initialize Kubernetes Cluster
sudo kubeadm init --pod-network-cidr=192.168.0.0/16
ğŸ“Œ Output mein kubeconfig aur join command milegi.

---

ğŸŸ¢ Step 4: Configure kubectl
mkdir -p $HOME/.kube
sudo cp /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

---

ğŸŸ¢ Step 5: Install Calico CNI
kubectl apply -f [https://docs.projectcalico.org/manifests/calico.yaml](https://docs.projectcalico.org/manifests/calico.yaml)

---

ğŸŸ¢ Step 6: Install Helm
curl [https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3](https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3) | bash
helm version

---

ğŸ“¦ Step 7: Install Loki Stack via Helm (Loki + Promtail + Grafana)

---

ğŸ”¹ 7.1 Add Loki Helm Repository
helm repo add grafana [https://grafana.github.io/helm-charts](https://grafana.github.io/helm-charts)
helm repo update
ğŸ§¾ Roman Urdu:
Helm ko batate hain k Grafana ke charts kahan se aayenge. Update se latest charts milte hain.

---

ğŸ”¹ 7.2 Remove Control Plane Taint (if single node only)
kubectl taint nodes --all node-role.kubernetes.io/control-plane-
ğŸ§¾ Roman Urdu:
Single node cluster mein pods control plane pe hi run karne padte hain â€” isliye taint hata rahe hain.

---

ğŸ”¹ 7.3 Create Logging Namespace
kubectl create namespace logging
ğŸ§¾ Roman Urdu:
Logging components ko alag namespace mein isolate kar rahe hain.

---

ğŸ”¹ 7.4 Install Loki Stack
helm install loki-stack grafana/loki-stack \
--namespace=logging \
--set grafana.enabled=true \
--set prometheus.enabled=false \
--set loki.persistence.enabled=false \
--set fluent-bit.enabled=false \
--set promtail.enabled=true \
--wait \
--timeout 10m
ğŸ§¾ Roman Urdu Explanation:
â€¢ Loki logs collect karega
â€¢ Promtail har pod se logs collect karke Loki ko bhejega
â€¢ Grafana dashboard enable kiya gaya hai
â€¢ Prometheus ko yahan disable kiya hai (already hoga to conflict nahi karega)
â€¢ --wait aur --timeout se ensure hota hai deployment complete ho

---

ğŸ” Step 8: Check Pods
kubectl get pods -n logging
Make sure following pods are running:
â€¢ loki-stack-promtail
â€¢ loki-stack-grafana
â€¢ loki-stack-loki

---

ğŸŒ Step 9: Access Grafana (via Port Forward)
kubectl port-forward svc/loki-stack-grafana 3000:80 -n logging
ğŸ“Œ Apne PC browser mein open karo:
[http://localhost:3000](http://localhost:3000)

---

ğŸ”‘ Step 10: Login to Grafana
kubectl get secret --namespace logging loki-stack-grafana -o jsonpath="{.data.admin-password}" | base64 -d
Username: admin
Password: (above output)
ğŸ§¾ Roman Urdu:
Yeh Grafana ka default login password hai â€” jo secret mein store hota hai.

---

ğŸ“Š Step 11: View Logs in Grafana

1. Browser mein [http://localhost:3000](http://localhost:3000) open karo
2. Login karo (admin / password from above)
3. Jaao â€œExploreâ€ tab mein (left sidebar se)
4. Top left source select karo: Loki
5. Query likho:
   Note : bss ye query {job=~".+"} run hogi baqi ko run krny k liye setting chaye jaisy pods query k liye pods likha hona chaye .
   Other queries
   {job="kubernetes-pods"}
6. Ya use filter:
   {pod=~".*nginx.*"}
   ğŸ§¾ Roman Urdu:
   Tu pod ke logs real-time dekh sakta hai, errors, restarts, ya warnings filter kar sakta hai.

---

ğŸ§  Conceptual Explanation â€” Why Loki?
ğŸ¯ Problem:
Kubernetes logs default mein sirf kubectl logs se milte hain â€” wo bhi ek pod ke liye.
Agar 100 pods hain, tu har pod ke logs manually nikaale ga? ğŸ˜£

---

âœ… Solution: Loki
â€¢ Loki har pod ke logs ko centralized collect karta hai
â€¢ Promtail us cluster ke har node pe run karta hai aur logs Loki ko bhejta hai
â€¢ Grafana se tu har container, node, pod ke logs real-time dekh sakta hai
â€¢ Filter, search, save aur visualize kar sakta hai without SSH or kubectl

---

ğŸ§µ Real-Life Analogy:
Jaise ek factory mein har machine ka CCTV log center mein jata hai,
waise hi Loki har pod ke log ko ek jagah pe bhejta hai â€” taake tu easily dekh sake kya problem ho rahi hai.

---

âœ… Assignment (Same EC2 par)
ğŸ¯ Complete this hands-on:

1. Login to Grafana at [http://localhost:3000](http://localhost:3000)
2. Go to â€œExploreâ€ tab
3. Filter logs using these queries:
   o {job="kubernetes-pods"}
   o {pod=~".*calico.*"}
   o {container=~".*coredns.*"}
4. Save a screenshot of logs
5. ğŸ”¥ Bonus: Create alert in Grafana if logs contain level=error in any pod
