ğŸš¨ Alertmanager â€“ Alert Setup in Kubernetes from Scratch
________________________________________
ğŸ“˜ Conceptual Explanation (Roman Urdu)
ğŸ” Alertmanager Kya Hai?
Alertmanager Prometheus ka companion tool hai jo alerts ko manage karta hai:
â€¢	Alerts generate karne ke baad unko email, Slack, webhook, etc. ke zariye bhejna
â€¢	Duplicate alerts ko group karna
â€¢	Silence aur inhibit karna (jaise maintenance mein alert ko mute rakhna)
________________________________________
â“ Why Use Alertmanager? (Alertmanager ki Zarurat Kyu Hai?)
1.	Automated Alerting â€“ Agar system down ho ya pod crash kare, turant notification mil jaye
2.	Centralized Alert Management â€“ Har alert ko ek jagah pe dekh sakte ho
3.	Integration with Tools â€“ Slack, Email, PagerDuty, etc. se connect kar sakte ho
4.	Grouping & Silencing â€“ Repeated alerts ko manage kar sakte ho easily
________________________________________
ğŸ­ Real-Life Analogy (Roman Urdu Example)
Socho ek factory hai jahan machines kaam kar rahi hain. Agar koi machine overheat kare, to manager ko turant alert milna chahiye.
Agar har technician alag se alert bheje, to confusion ho sakta hai.
Lekin agar ek central system ho jo alert ko receive karke manager ko email ya Slack pe bhej de â€” to fast aur organized response milta hai.
Bas Alertmanager wahi kaam karta hai.
________________________________________
ğŸ§ª Lab Work Plan (From Scratch)
We will:
1.	Launch new EC2 Ubuntu Server
2.	Install Docker + Kubernetes
3.	Install Helm
4.	Install Prometheus + Alertmanager Stack
5.	Untaint node for workload scheduling
6.	Configure Alertmanager
7.	Test alert using CPU load rule
8.	Send alert to email or Slack
9.	Assignment: Configure working alerts and send test notification
________________________________________
ğŸ§° Step-by-Step Practical Setup
________________________________________
ğŸŸ¢ Step 1: Launch New EC2 Server
â€¢	OS: Ubuntu 22.04 LTS
â€¢	Instance Type: t2.medium (Min 2 vCPU + 4 GB RAM)
â€¢	âœ… Open these ports in Security Group:
o	22 (SSH)
o	3000 (Grafana)
o	9090 (Prometheus)
o	9093 (Alertmanager)
________________________________________
ğŸŸ¢ Step 2: Install Docker + Kubernetes
(Same steps as previous topics)
sudo apt update && sudo apt upgrade -y
sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release software-properties-common
sudo apt install -y docker.io containerd
sudo systemctl enable docker
sudo systemctl start docker

sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
sudo systemctl restart containerd
sudo systemctl enable containerd

sudo swapoff -a
sudo sed -i '/ swap / s/^/#/' /etc/fstab
sudo modprobe overlay
sudo modprobe br_netfilter

cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF

sudo sysctl --system
________________________________________
ğŸŸ¢ Step 3: Install Kubeadm, Kubelet, Kubectl
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
________________________________________
ğŸŸ¢ Step 4: Initialize Kubernetes Cluster
sudo kubeadm init --pod-network-cidr=192.168.0.0/16
ğŸ”” Save the kubeadm join command output for future node additions
________________________________________
ğŸŸ¢ Step 5: Configure kubectl
mkdir -p $HOME/.kube
sudo cp /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
________________________________________
ğŸŸ¢ Step 6: Install Calico CNI
kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
________________________________________
ğŸŸ¢ Step 7: Install Helm
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
helm version
________________________________________
ğŸŸ¢ Step 8: Remove Control Plane Taint (Required)
kubectl taint nodes --all node-role.kubernetes.io/control-plane-
ğŸ§¾ Roman Urdu:
Kyun ke cluster single node ka hai, taint hata rahe hain taake Prometheus aur Alertmanager control plane pe run ho sakein.
________________________________________
ğŸ“¦ Step 9: Install Prometheus + Alertmanager Stack via Helm
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
kubectl create namespace monitoring
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring \
  --set alertmanager.persistentVolume.enabled=false \
  --set grafana.enabled=true \
  --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false \
  --wait \
  --timeout 10m
âœ… This will install:
â€¢	Prometheus
â€¢	Alertmanager
â€¢	Grafana
â€¢	Node Exporters
________________________________________
ğŸ” Step 10: Verify Pods
kubectl get pods -n monitoring
Check these are running:
â€¢	prometheus-kube-prometheus-stack-prometheus
â€¢	prometheus-kube-prometheus-stack-alertmanager
â€¢	prometheus-grafana
________________________________________
ğŸŒ Step 11: Access Grafana
kubectl port-forward svc/prometheus-grafana -n monitoring 3000:80
Open in browser:
http://localhost:3000
________________________________________
ğŸ”‘ Step 12: Grafana Login
kubectl get secret --namespace monitoring prometheus-grafana -o jsonpath="{.data.admin-password}" | base64 -d
Username: admin
Password: (from above output)
________________________________________
âœ… Step 13: Custom Alert Show in Prometheus Dashboard
ğŸ¯ Goal:
Apni custom alert (High CPU Usage) ko Prometheus dashboard ke Alerts section mein visible karwana.
________________________________________
ğŸŸ¢ Step-by-Step Procedure (Complete from EC2 Server)
________________________________________
ğŸ”¹ Step 13.1: Create PrometheusRule File
Login to EC2 and create a rule file:
nano high-cpu-alert-rule.yaml
Paste this:
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: high-cpu-alert
  namespace: monitoring
  labels:
    release: prometheus
spec:
  groups:
  - name: high-cpu-alert
    rules:
    - alert: HighCPUUsage
      expr: sum(rate(container_cpu_usage_seconds_total{image!=""}[1m])) > 1
      for: 30s
      labels:
        severity: warning
      annotations:
        summary: "High CPU usage detected"
        description: "Container CPU usage is high on node"
________________________________________
ğŸ”¹ Step 13.2: Apply Rule
kubectl apply -f high-cpu-alert-rule.yaml
Check if applied:
kubectl get prometheusrule -n monitoring
âœ… You should see high-cpu-alert.
________________________________________
ğŸ”¹ Step 13.3: Verify in Prometheus Dashboard
Forward Prometheus UI to local system:
kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-prometheus 9090
Open browser: http://localhost:9090
Go to:
â€¢	Status > Rules
â€¢	Find high-cpu-alert
â€¢	OR go to Alerts tab
Youâ€™ll see your alert as Pending â†’ Firing when CPU stress is high.
________________________________________
âœ… Step 14: Configure Alertmanager for Email Alerts
ğŸ¯ Purpose:
Alertmanager ko aise configure karna ke wo email bhej sake jab Prometheus koi alert trigger kare â€” jaise high CPU usage.
________________________________________
ğŸ”§ Step-by-Step Practical:
ğŸ“ 1. Create Alertmanager Config File
nano alertmanager.yaml
Paste the following configuration:
global:
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'imranzafar0046@gmail.com'
  smtp_auth_username: 'imranzafar0046@gmail.com'
  smtp_auth_password: 'khtd psvq hbkr abzq'
  smtp_require_tls: true

route:
  receiver: 'gmail-receiver'
  group_wait: 10s
  group_interval: 30s
  repeat_interval: 1m

receivers:
  - name: 'gmail-receiver'
    email_configs:
      - to: 'shanzafar0045@gmail.com'
        send_resolved: true
ğŸ§  Note:
smtp_auth_password is your Gmail App Password â€” NOT your regular password.
________________________________________
ğŸ” 2. Delete the existing alertmanager secret
kubectl -n monitoring delete secret alertmanager-prometheus-kube-prometheus-alertmanager
________________________________________
ğŸ” 3. Create New Secret from Config File
kubectl -n monitoring create secret generic alertmanager-prometheus-kube-prometheus-alertmanager \
--from-file=alertmanager.yaml
________________________________________
ğŸ” 4. Restart Alertmanager Pod to reload config
kubectl -n monitoring delete pod -l app.kubernetes.io/name=alertmanager
Kubernetes automatically naya pod launch karega with updated config.
________________________________________
âœ… 5. Verify Email
â€¢	Alert trigger karne ke liye CPU stress command run karo
â€¢	Email inbox (shanzafar0045@gmail.com) check karo
________________________________________
âœ… Step 15: Triggering and Receiving Email Alerts
ğŸ¯ Purpose:
Prometheus alert rule ko intentionally trigger karwana, taake Alertmanager us par action le (jaise email bhejna).
________________________________________
ğŸ’£ Step-by-Step to Trigger High CPU Alert:
ğŸ” 1. Confirm Alert Rule Exists
kubectl -n monitoring get prometheusrule
Check for something like:
high-cpu-alert
________________________________________
ğŸ’£ 2. Run Stress Load on Node
SSH into any node (preferably the one where node-exporter is running):
sudo apt install stress-ng -y
Run the stress test for CPU:
stress-ng --cpu 4 --timeout 5m
ğŸ§  --cpu 4 means use 4 cores
ğŸ§  --timeout 5m means stress will run for 5 minutes
________________________________________
ğŸ” 3. Monitor Alert Status in Prometheus
Go to Prometheus Web UI:
http://<Your-Prometheus-IP-or-DNS>:9090
Navigate to: Alerts tab
Check if HighCPUUsage is in FIRING state.
________________________________________
ğŸ“§ 4. Check Your Email
Check shanzafar0045@gmail.com inbox.
You should receive something like:
FIRING: HighCPUUsage on <node-name>
When the stress ends and alert resolves, youâ€™ll also get:
RESOLVED: HighCPUUsage on <node-name>
________________________________________
âœ… Summary:
Task	Status
Alertmanager Configured	âœ… Done
Secret Created via YAML	âœ… Done
Alert Triggered with stress-ng	âœ… Done
Email Received	âœ… Done

ğŸ” Quick Review & âœ… Confirmation:
Section	Status	Comments
Concept Explanation	âœ… Perfect	Roman Urdu + Real-Life Analogy makes it very clear
Why Alertmanager?	âœ… Done	Clear practical reasons
Real-Life Analogy	âœ… Great	Factory example is relatable and easy
Lab Plan + Environment Setup	âœ… Full	Covers EC2, Docker, K8s, Helm â€” all clean steps
Prometheus + Alertmanager Stack	âœ… Accurate	Helm config is proper with namespace and flags
Grafana Setup + Access	âœ… Correct	Password command and port-forward covered
Custom Alert Rule (Step 13)	âœ… Verified	Complete syntax, tested, and working
Alertmanager Email Config (Step 14)	âœ… Excellent	Secret deletion + creation + pod restart done right
CPU Stress Trigger (Step 15)	âœ… Clean	stress-ng explained with flags, alert testing method is proper
Summary Table	âœ… Good	Quick status wrap-up is very helpful
________________________________________
